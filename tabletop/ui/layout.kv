#:import IconButton tabletop.ui.widgets.IconButton
#:import CardWidget tabletop.ui.widgets.CardWidget
#:import RotatableLabel tabletop.ui.widgets.RotatableLabel
#:import ASSETS tabletop.ui.assets.ASSETS
#:import RoundedRectangle kivy.graphics.vertex_instructions.RoundedRectangle

<TrackerHostDialog@ModalView>:
    size_hint: None, None
    size: 720, 420
    auto_dismiss: False
    background: ""
    background_color: 0, 0, 0, 0
    vp1: ""
    vp2: ""
    error_message: ""

    BoxLayout:
        orientation: "vertical"
        padding: 40
        spacing: 24

        canvas.before:
            Color:
                rgba: 0.08, 0.08, 0.08, 0.92
            RoundedRectangle:
                pos: self.pos
                size: self.size
                radius: [18]

        Label:
            text: "Tracker-Einstellungen"
            font_size: "28sp"
            size_hint_y: None
            height: self.texture_size[1]
            bold: True

        GridLayout:
            cols: 2
            spacing: 16
            row_force_default: True
            row_default_height: 70
            size_hint_y: None
            height: self.minimum_height

            Label:
                text: "VP1"
                halign: "right"
                valign: "middle"
                text_size: self.size

            TextInput:
                id: vp1_input
                text: root.vp1
                hint_text: "z.B. 192.168.0.10:8080"
                multiline: False
                write_tab: False

            Label:
                text: "VP2"
                halign: "right"
                valign: "middle"
                text_size: self.size

            TextInput:
                id: vp2_input
                text: root.vp2
                hint_text: "z.B. 192.168.0.11:8080"
                multiline: False
                write_tab: False

        Label:
            id: error_label
            text: root.error_message
            color: (1, 0.35, 0.35, 1)
            size_hint_y: None
            height: self.texture_size[1] + (10 if self.text else 0)
            text_size: self.width, None
            halign: "center"

        Button:
            text: "Speichern"
            size_hint_y: None
            height: 80
            font_size: "22sp"
            on_release: root.confirm()

<TabletopRoot>:
    horizontal_offset: 0.08  # fraction of total width (≈8%)
    canvas.before:
        Color:
            rgba: (1, 1, 1, 1) if root.bg_texture else (0.75, 0.75, 0.75, 1)
        Rectangle:
            pos: self.pos
            size: self.size
            texture: root.bg_texture

    btn_start_p1: btn_start_p1
    btn_start_p2: btn_start_p2
    p1_outer: p1_outer
    p1_inner: p1_inner
    p2_outer: p2_outer
    p2_inner: p2_inner
    intro_overlay: intro_overlay
    pause_cover: pause_cover
    fixation_overlay: fixation_overlay
    fixation_image: fixation_image
    round_badge: round_badge
    settings_button: settings_button

    IconButton:
        id: btn_start_p1
        source_normal: ASSETS['play']['stop']
        source_down: ASSETS['play']['live']
        size_hint: None, None
        size: 360 * root.button_scale * root.scale, 360 * root.button_scale * root.scale
        pos: root.width - root.horizontal_margin_px - self.width - 120 * root.scale, 300 * root.scale

    IconButton:
        id: btn_start_p2
        source_normal: ASSETS['play']['stop']
        source_down: ASSETS['play']['live']
        size_hint: None, None
        size: 360 * root.button_scale * root.scale, 360 * root.button_scale * root.scale
        pos: root.horizontal_margin_px + 120 * root.scale, root.height - 300 * root.scale - self.height

    CardWidget:
        id: p1_outer
        size_hint: None, None
        size: 336 * root.scale, 512 * root.scale
        pos: root.horizontal_margin_px + 100 * root.scale, 300 * root.scale

    CardWidget:
        id: p1_inner
        size_hint: None, None
        size: 336 * root.scale, 512 * root.scale
        pos: root.ids.p1_outer.right + 70 * root.scale, 300 * root.scale

    CardWidget:
        id: p2_outer
        size_hint: None, None
        size: 336 * root.scale, 512 * root.scale
        pos: root.width - root.horizontal_margin_px - self.width - 100 * root.scale, root.height - 300 * root.scale - self.height

    CardWidget:
        id: p2_inner
        size_hint: None, None
        size: 336 * root.scale, 512 * root.scale
        pos: root.ids.p2_outer.x - self.width - 70 * root.scale, root.ids.p2_outer.y

    IconButton:
        id: signal_p1_low
        source_normal: ASSETS['signal']['low']['stop']
        source_down: ASSETS['signal']['low']['live']
        size_hint: None, None
        size: 260 * root.button_scale * root.scale, 260 * root.button_scale * root.scale
        pos: root.width - root.horizontal_margin_px - self.width - 780 * root.scale, 180 * root.scale + 820 * root.scale


    IconButton:
        id: signal_p1_mid
        source_normal: ASSETS['signal']['mid']['stop']
        source_down: ASSETS['signal']['mid']['live']
        size_hint: None, None
        size: 260 * root.button_scale * root.scale, 260 * root.button_scale * root.scale
        pos: root.ids.signal_p1_low.x, root.ids.signal_p1_low.top + 40 * root.button_scale * root.scale

    IconButton:
        id: signal_p1_high
        source_normal: ASSETS['signal']['high']['stop']
        source_down: ASSETS['signal']['high']['live']
        size_hint: None, None
        size: 260 * root.button_scale * root.scale, 260 * root.button_scale * root.scale
        pos: root.ids.signal_p1_mid.x, root.ids.signal_p1_mid.top + 40 * root.button_scale * root.scale

    IconButton:
        id: decision_p1_bluff
        source_normal: ASSETS['decide']['bluff']['stop']
        source_down: ASSETS['decide']['bluff']['live']
        size_hint: None, None
        size: 260 * root.button_scale * root.scale, 260 * root.button_scale * root.scale
        pos: root.ids.signal_p1_low.x - self.width - 60 * root.button_scale * root.scale, root.ids.signal_p1_low.y

    IconButton:
        id: decision_p1_wahr
        source_normal: ASSETS['decide']['wahr']['stop']
        source_down: ASSETS['decide']['wahr']['live']
        size_hint: None, None
        size: 260 * root.button_scale * root.scale, 260 * root.button_scale * root.scale
        pos: root.ids.decision_p1_bluff.x, root.ids.decision_p1_bluff.top + 40 * root.button_scale * root.scale

    IconButton:
        id: signal_p2_low
        source_normal: ASSETS['signal']['low']['stop']
        source_down: ASSETS['signal']['low']['live']
        size_hint: None, None
        size: 260 * root.button_scale * root.scale, 260 * root.button_scale * root.scale
        pos: root.horizontal_margin_px + 780 * root.scale, root.height - 180 * root.scale - 820 * root.scale - self.height

    IconButton:
        id: signal_p2_mid
        source_normal: ASSETS['signal']['mid']['stop']
        source_down: ASSETS['signal']['mid']['live']
        size_hint: None, None
        size: 260 * root.button_scale * root.scale, 260 * root.button_scale * root.scale
        pos: root.ids.signal_p2_low.x, root.ids.signal_p2_low.y - root.ids.signal_p2_low.height - 40 * root.button_scale * root.scale

    IconButton:
        id: signal_p2_high
        source_normal: ASSETS['signal']['high']['stop']
        source_down: ASSETS['signal']['high']['live']
        size_hint: None, None
        size: 260 * root.button_scale * root.scale, 260 * root.button_scale * root.scale
        pos: root.ids.signal_p2_mid.x, root.ids.signal_p2_mid.y - root.ids.signal_p2_mid.height - 40 * root.button_scale * root.scale

    IconButton:
        id: decision_p2_bluff
        source_normal: ASSETS['decide']['bluff']['stop']
        source_down: ASSETS['decide']['bluff']['live']
        size_hint: None, None
        size: 260 * root.button_scale * root.scale, 260 * root.button_scale * root.scale
        pos: root.ids.signal_p2_low.right + 60 * root.button_scale * root.scale, root.ids.signal_p2_low.y

    IconButton:
        id: decision_p2_wahr
        source_normal: ASSETS['decide']['wahr']['stop']
        source_down: ASSETS['decide']['wahr']['live']
        size_hint: None, None
        size: 260 * root.button_scale * root.scale, 260 * root.button_scale * root.scale
        pos: root.ids.decision_p2_bluff.x, root.ids.decision_p2_bluff.y - root.ids.decision_p2_bluff.height - 40 * root.button_scale * root.scale

    Button:
        id: settings_button
        text: "⚙ Einstellungen"
        size_hint: None, None
        size: 360 * root.button_scale * root.scale, 120 * root.button_scale * root.scale
        pos: root.width - root.horizontal_margin_px - self.width - 120 * root.scale, root.height - self.height - 140 * root.scale
        font_size: 48 * root.scale
        background_normal: ""
        background_down: ""
        background_color: (0.12, 0.12, 0.12, 0.85)
        color: (1, 1, 1, 1)

    Image:
        id: center_p1_card_right
        size_hint: None, None
        fit_mode: "contain"
        size: 380 * root.scale, 560 * root.scale
        pos: root.width / 2 + 45 * root.scale, root.height / 2 - self.height - 30 * root.scale

    Image:
        id: center_p1_card_left
        size_hint: None, None
        fit_mode: "contain"
        size: 380 * root.scale, 560 * root.scale
        pos: root.width / 2 - self.width - 45 * root.scale, root.height / 2 - self.height - 30 * root.scale

    Image:
        id: center_p2_card_left
        size_hint: None, None
        fit_mode: "contain"
        size: 380 * root.scale, 560 * root.scale
        pos: root.width / 2 - self.width - 45 * root.scale, root.height / 2 + 30 * root.scale

    Image:
        id: center_p2_card_right
        size_hint: None, None
        fit_mode: "contain"
        size: 380 * root.scale, 560 * root.scale
        pos: root.width / 2 + 45 * root.scale, root.height / 2 + 30 * root.scale

    RotatableLabel:
        id: user_display_p1
        size_hint: None, None
        size: 1042 * root.scale, 660 * root.scale
        pos: root.width / 2 - 380 * root.scale - 45 * root.scale - 96 * root.scale, root.height / 2 - 560 * root.scale - 30 * root.scale - 40 * root.scale - self.height
        text_size: self.width - 2 * 60 * root.scale, self.height - 2 * 40 * root.scale
        padding: 60 * root.scale, 40 * root.scale
        font_size: 38.4 * root.scale if root.scale else 38.4
        halign: 'left'
        valign: 'top'
        color: 1, 1, 1, 1
        markup: True

    RotatableLabel:
        id: user_display_p2
        size_hint: None, None
        size: 1042 * root.scale, 660 * root.scale
        pos: root.width / 2 - 380 * root.scale - 45 * root.scale - 96 * root.scale, root.height / 2 + 560 * root.scale + 30 * root.scale + 40 * root.scale
        text_size: self.width - 2 * 60 * root.scale, self.height - 2 * 40 * root.scale
        padding: 60 * root.scale, 40 * root.scale
        font_size: 38.4 * root.scale if root.scale else 38.4
        halign: 'left'
        valign: 'top'
        color: 1, 1, 1, 1
        markup: True

    FloatLayout:
        id: intro_overlay
        size_hint: 1, 1
        canvas.before:
            Color:
                rgba: 0.75, 0.75, 0.75, 1
            Rectangle:
                pos: self.pos
                size: self.size
        RotatableLabel:
            id: intro_label_p1
            text: '[b]Willkommen![/b]\nBitte warten Sie, bis die Session gestartet wurde.'
            halign: 'center'
            valign: 'middle'
            color: 0, 0, 0, 1
            markup: True
            size_hint: None, None
            size: root.width * 0.6, root.height * 0.25
            pos: root.width / 2 - self.width / 2, root.height / 2 - 120 * root.scale / 2 - self.height
            text_size: self.width - 2 * 40 * root.scale, self.height - 2 * 40 * root.scale
            padding: 40 * root.scale, 40 * root.scale
            font_size: 64 * root.scale if root.scale else 64
        RotatableLabel:
            id: intro_label_p2
            text: '[b]Willkommen![/b]\nBitte warten Sie, bis die Session gestartet wurde.'
            halign: 'center'
            valign: 'middle'
            color: 0, 0, 0, 1
            markup: True
            size_hint: None, None
            size: root.width * 0.6, root.height * 0.25
            pos: root.width / 2 - self.width / 2, root.height / 2 + 120 * root.scale / 2
            text_size: self.width - 2 * 40 * root.scale, self.height - 2 * 40 * root.scale
            padding: 40 * root.scale, 40 * root.scale
            font_size: 64 * root.scale if root.scale else 64
        AnchorLayout:
            id: startup_anchor
            size_hint: 1, 1
            anchor_x: 'center'
            anchor_y: 'center'
            BoxLayout:
                id: startup_panel
                orientation: 'vertical'
                size_hint: None, None
                width: min(root.width * 0.6, 880 * root.scale if root.scale else 880)
                height: self.minimum_height
                padding: 32 * root.scale, 32 * root.scale
                spacing: 18 * root.scale
                canvas.before:
                    Color:
                        rgba: 0.08, 0.08, 0.08, 0.92
                    RoundedRectangle:
                        pos: self.pos
                        size: self.size
                        radius: [24 * root.scale if root.scale else 24]

                Label:
                    text: 'Session Setup'
                    font_size: 48 * root.scale if root.scale else 48
                    size_hint_y: None
                    height: self.texture_size[1]
                    color: 1, 1, 1, 1
                    bold: True
                    halign: 'left'
                    valign: 'middle'
                    text_size: self.size

                TextInput:
                    id: startup_session_input
                    hint_text: 'Session ID'
                    multiline: False
                    write_tab: False
                    size_hint_y: None
                    height: 60 * root.scale if root.scale else 60
                    font_size: 32 * root.scale if root.scale else 32
                    on_text: root.on_startup_session_text(self.text)

                TextInput:
                    id: startup_block_input
                    hint_text: 'Block ID (optional)'
                    multiline: False
                    write_tab: False
                    size_hint_y: None
                    height: 60 * root.scale if root.scale else 60
                    font_size: 32 * root.scale if root.scale else 32
                    on_text: root.on_startup_block_text(self.text)

                GridLayout:
                    cols: 2
                    size_hint_y: None
                    height: self.minimum_height
                    col_default_width: self.width / 2
                    col_force_default: False
                    row_default_height: 60 * root.scale if root.scale else 60
                    row_force_default: True
                    spacing: 16 * root.scale

                    Label:
                        text: 'Aruco-Overlay aktivieren'
                        color: 1, 1, 1, 1
                        font_size: 28 * root.scale if root.scale else 28
                        halign: 'left'
                        valign: 'middle'
                        text_size: self.size
                    Switch:
                        id: startup_overlay_switch
                        size_hint_x: None
                        width: 120 * root.scale if root.scale else 120

                    Label:
                        text: 'Startblock (1=Übung, 2–5=Experimental)'
                        color: 1, 1, 1, 1
                        font_size: 28 * root.scale if root.scale else 28
                        halign: 'left'
                        valign: 'middle'
                        text_size: self.size
                    Spinner:
                        id: startup_start_block_spinner
                        text: '1'
                        values: [str(i) for i in range(1, 6)]
                        size_hint: None, None
                        size: 160 * root.scale if root.scale else 160, 60 * root.scale if root.scale else 60

                Label:
                    id: startup_error_label
                    text: ''
                    color: (1, 0.35, 0.35, 1)
                    size_hint_y: None
                    height: self.texture_size[1] + (10 if self.text else 0)
                    font_size: 24 * root.scale if root.scale else 24
                    halign: 'left'
                    valign: 'middle'
                    text_size: self.size

                BoxLayout:
                    id: startup_status_container
                    orientation: 'vertical'
                    size_hint_y: None
                    height: self.minimum_height
                    spacing: 6 * root.scale

                    Label:
                        id: startup_status_connect
                        text: 'Verbinde Tracker…'
                        color: 1, 1, 1, 1
                        font_size: 28 * root.scale if root.scale else 28
                        halign: 'left'
                        valign: 'middle'
                        text_size: self.size
                        size_hint_y: None
                        height: self.texture_size[1]

                    Label:
                        id: startup_status_vp1
                        text: 'Starte Aufnahme VP1…'
                        color: 1, 1, 1, 1
                        font_size: 28 * root.scale if root.scale else 28
                        halign: 'left'
                        valign: 'middle'
                        text_size: self.size
                        size_hint_y: None
                        height: self.texture_size[1]

                    Label:
                        id: startup_status_vp2
                        text: 'Starte Aufnahme VP2…'
                        color: 1, 1, 1, 1
                        font_size: 28 * root.scale if root.scale else 28
                        halign: 'left'
                        valign: 'middle'
                        text_size: self.size
                        size_hint_y: None
                        height: self.texture_size[1]

                BoxLayout:
                    id: startup_progress_row
                    size_hint_y: None
                    height: 40 * root.scale if root.scale else 40
                    spacing: 12 * root.scale

                    Label:
                        id: startup_progress_label
                        text: '⏳'
                        color: 1, 1, 1, 1
                        font_size: 32 * root.scale if root.scale else 32
                        size_hint_x: None
                        width: self.texture_size[0]
                        opacity: 0

                    Label:
                        id: startup_progress_text
                        text: 'Bitte warten…'
                        color: 1, 1, 1, 1
                        font_size: 24 * root.scale if root.scale else 24
                        halign: 'left'
                        valign: 'middle'
                        text_size: self.size
                        opacity: 0

                    Widget:
                        size_hint_x: 1

                BoxLayout:
                    size_hint_y: None
                    height: 60 * root.scale if root.scale else 60
                    spacing: 12 * root.scale

                    Button:
                        id: startup_retry_button
                        text: 'Erneut versuchen'
                        size_hint_x: None
                        width: 240 * root.scale if root.scale else 240
                        font_size: 24 * root.scale if root.scale else 24
                        opacity: 0
                        disabled: True
                        on_release: root.handle_startup_retry()

                    Widget:
                        size_hint_x: 1

                BoxLayout:
                    size_hint_y: None
                    height: 60 * root.scale if root.scale else 60
                    spacing: 12 * root.scale

                    Button:
                        id: startup_ok_button
                        text: 'OK'
                        font_size: 28 * root.scale if root.scale else 28
                        disabled: not root.startup_session_valid
                        on_release: root.handle_startup_ok()

                    Button:
                        id: startup_play_button
                        text: 'Play'
                        font_size: 28 * root.scale if root.scale else 28
                        disabled: False
                        opacity: 1.0
                        on_release: root.handle_startup_play()

    BoxLayout:
        id: status_bar_container
        size_hint: 0.7, None
        height: 64 * root.scale if root.scale else 64
        pos_hint: {"center_x": 0.5}
        y: 20 * root.scale
        padding: 24 * root.scale, 12 * root.scale
        spacing: 16 * root.scale
        canvas.before:
            Color:
                rgba: 0.05, 0.05, 0.05, 0.7
            RoundedRectangle:
                pos: self.pos
                size: self.size
                radius: [18 * root.scale if root.scale else 18]

        Label:
            id: status_bar
            text: root.status_bar_text
            color: 1, 1, 1, 1
            font_size: 28 * root.scale if root.scale else 28
            halign: 'left'
            valign: 'middle'
            text_size: self.size

    Label:
        id: round_badge
        size_hint: None, None
        size: 1400 * root.scale, 70 * root.scale
        pos: root.width / 2 - self.width / 2, 90 * root.scale
        font_size: 40 * root.scale if root.scale else 40
        color: 1, 1, 1, 1
        halign: 'center'
        valign: 'middle'
        text_size: self.size

    FloatLayout:
        id: pause_cover
        size_hint: 1, 1
        opacity: 0
        disabled: True
        canvas.before:
            Color:
                rgba: 0.75, 0.75, 0.75, 1
            Rectangle:
                pos: self.pos
                size: self.size
        RotatableLabel:
            id: pause_label_p1
            size_hint: None, None
            size: root.width * 0.8, root.height * 0.25
            pos: root.width * 0.1, 40 * root.scale
            halign: 'center'
            valign: 'middle'
            color: 0, 0, 0, 1
            text_size: self.size
            font_size: 56 * root.scale if root.scale else 56
        RotatableLabel:
            id: pause_label_p2
            size_hint: None, None
            size: root.width * 0.8, root.height * 0.25
            pos: root.width * 0.1, root.height - 40 * root.scale - self.height
            halign: 'center'
            valign: 'middle'
            color: 0, 0, 0, 1
            text_size: self.size
            font_size: 56 * root.scale if root.scale else 56
        IconButton:
            id: pause_btn_p1
            source_normal: ASSETS['play']['stop']
            source_down: ASSETS['play']['live']
            size_hint: None, None
            size: 360 * root.button_scale * root.scale, 360 * root.button_scale * root.scale
            pos: root.width - root.horizontal_margin_px - self.width - 120 * root.scale, 300 * root.scale
        IconButton:
            id: pause_btn_p2
            source_normal: ASSETS['play']['stop']
            source_down: ASSETS['play']['live']
            size_hint: None, None
            size: 360 * root.button_scale * root.scale, 360 * root.button_scale * root.scale
            pos: root.horizontal_margin_px + 120 * root.scale, root.height - 300 * root.scale - self.height

    FloatLayout:
        id: fixation_overlay
        size_hint: 1, 1
        opacity: 0
        disabled: True
        Image:
            id: fixation_image
            size_hint: 1, 1
            fit_mode: "contain"
            pos: 0, 0
